"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var kinvey_nativescript_sdk_1 = require("kinvey-nativescript-sdk");
var rxjs_1 = require("rxjs");
var care_plan_activity_model_1 = require("./care-plan-activity.model");
var care_plan_event_model_1 = require("./care-plan-event.model");
var CareCardEventService = /** @class */ (function () {
    function CareCardEventService() {
        this._eventsDataStore = kinvey_nativescript_sdk_1.Kinvey.DataStore.collection("Event");
        this._events = new Array();
        // Observable events source
        this._updatedEventItemSource = new rxjs_1.BehaviorSubject(null);
        // Observable events stream
        this.updatedEvent$ = this._updatedEventItemSource.asObservable();
    }
    CareCardEventService.prototype.upsertEvent = function (event, eventsCount) {
        var _this = this;
        return this.findEvents(event.activity.title, event.date)
            .then(function (registeredEvents) {
            var promiseQueue = Promise.resolve();
            if (registeredEvents.length === eventsCount) {
                var eventToUpdate = registeredEvents.find(function (currentEvent) {
                    return currentEvent.occurrenceIndexOfDay === event.occurrenceIndexOfDay;
                });
                eventToUpdate = event;
            }
            else {
                _this._events.push(event);
                promiseQueue = promiseQueue.then(function () { return _this.saveEvent(event); });
            }
            return promiseQueue;
        })
            .then(function () { return _this._updatedEventItemSource.next(event); });
    };
    CareCardEventService.prototype.findEvents = function (title, date) {
        var _this = this;
        return this.getEvents()
            .then(function () {
            var filteredEvents = _this._events.filter(function (currentEvent) {
                return currentEvent.date.toDateString() === date.toDateString() &&
                    currentEvent.activity.title === title;
            });
            return filteredEvents;
        });
    };
    CareCardEventService.prototype.getEvents = function () {
        var _this = this;
        if (!this._eventsPromise) {
            this._eventsPromise = this._eventsDataStore.find().toPromise()
                .then(function (data) {
                var events = [];
                if (data && data.length) {
                    data.forEach(function (eventData) {
                        var activity = new care_plan_activity_model_1.CarePlanActivity(eventData.activity);
                        var jsonDate = eventData.date;
                        var date = new Date(jsonDate.year, jsonDate.month - 1, jsonDate.day);
                        var occurrenceIndexOfDay = eventData.occurrenceIndexOfDay;
                        var result = eventData.result;
                        var value = result && result.values && result.values.length ? result.values[0] : 1;
                        var event = new care_plan_event_model_1.CarePlanEvent(activity, date, occurrenceIndexOfDay, value);
                        events.push(event);
                    });
                }
                _this._events = events;
                return events;
            })
                .catch(function (error) {
                alert({
                    title: "Oops something went wrong.",
                    message: error.message,
                    okButtonText: "Ok"
                });
            });
        }
        return this._eventsPromise;
    };
    CareCardEventService.prototype.saveEvent = function (event) {
        var eventObject = {
            activity: event.activity.getJson(),
            date: {
                year: event.date.getUTCFullYear(),
                month: event.date.getUTCMonth() + 1,
                era: 1,
                day: event.date.getUTCDate()
            },
            numberOfDaysSinceStart: event.activity.getNumberOfDaysSinceStart(),
            occurrenceIndexOfDay: event.occurrenceIndexOfDay,
            state: 2 /* Completed */
        };
        if (event.activity.type === 1 /* Assessment */) {
            var result = {
                creationDate: new Date(),
                values: [event.value],
                valueString: event.value.toString()
            };
            if (event.activity.title === "Weight") {
                result.unitStringKeys = { lb: "lb" };
                result.displayUnit = "lb";
                result.unitString = "lb";
            }
            else {
                result.unitString = "of 10";
            }
            eventObject.result = result;
        }
        return this._eventsDataStore.save(eventObject);
    };
    CareCardEventService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [])
    ], CareCardEventService);
    return CareCardEventService;
}());
exports.CareCardEventService = CareCardEventService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FyZS1jYXJkLWV2ZW50LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjYXJlLWNhcmQtZXZlbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUEyQztBQUMzQyxtRUFBaUQ7QUFDakQsNkJBQW1EO0FBR25ELHVFQUE4RDtBQUM5RCxpRUFBd0Q7QUFTeEQ7SUFRSTtRQUpRLHFCQUFnQixHQUFHLGdDQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBTSxPQUFPLENBQUMsQ0FBQztRQUtqRSxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksS0FBSyxFQUFpQixDQUFDO1FBRTFDLDJCQUEyQjtRQUMzQixJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxzQkFBZSxDQUFnQixJQUFJLENBQUMsQ0FBQztRQUV4RSwyQkFBMkI7UUFDM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDckUsQ0FBQztJQUVELDBDQUFXLEdBQVgsVUFBWSxLQUFvQixFQUFFLFdBQW1CO1FBQXJELGlCQW1CQztRQWxCRyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDO2FBQ25ELElBQUksQ0FBQyxVQUFDLGdCQUFzQztZQUN6QyxJQUFJLFlBQVksR0FBRyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7WUFFckMsRUFBRSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQzFDLElBQUksYUFBYSxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxVQUFDLFlBQVk7b0JBQ25ELE1BQU0sQ0FBQyxZQUFZLENBQUMsb0JBQW9CLEtBQUssS0FBSyxDQUFDLG9CQUFvQixDQUFDO2dCQUM1RSxDQUFDLENBQUMsQ0FBQztnQkFFSCxhQUFhLEdBQUcsS0FBSyxDQUFDO1lBQzFCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixLQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDekIsWUFBWSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQXJCLENBQXFCLENBQUMsQ0FBQztZQUNsRSxDQUFDO1lBRUQsTUFBTSxDQUFDLFlBQVksQ0FBQztRQUN4QixDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQXhDLENBQXdDLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQseUNBQVUsR0FBVixVQUFXLEtBQWEsRUFBRSxJQUFVO1FBQXBDLGlCQVVDO1FBVEcsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7YUFDbEIsSUFBSSxDQUFDO1lBQ0YsSUFBTSxjQUFjLEdBQUcsS0FBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBQyxZQUFZO2dCQUNwRCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsS0FBSyxJQUFJLENBQUMsWUFBWSxFQUFFO29CQUMzRCxZQUFZLENBQUMsUUFBUSxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUM7WUFDOUMsQ0FBQyxDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsY0FBYyxDQUFDO1FBQzFCLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVPLHdDQUFTLEdBQWpCO1FBQUEsaUJBc0NDO1FBckNHLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLENBQUMsU0FBUyxFQUFFO2lCQUN6RCxJQUFJLENBQUMsVUFBQyxJQUFJO2dCQUNQLElBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztnQkFFbEIsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO29CQUN0QixJQUFJLENBQUMsT0FBTyxDQUFDLFVBQUMsU0FBYzt3QkFDeEIsSUFBTSxRQUFRLEdBQUcsSUFBSSwyQ0FBZ0IsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7d0JBRTFELElBQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7d0JBQ2hDLElBQU0sSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUUsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3dCQUV2RSxJQUFNLG9CQUFvQixHQUFHLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQzt3QkFFNUQsSUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQzt3QkFDaEMsSUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFFckYsSUFBTSxLQUFLLEdBQUcsSUFBSSxxQ0FBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLENBQUM7d0JBRTdFLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ3ZCLENBQUMsQ0FBQyxDQUFDO2dCQUNQLENBQUM7Z0JBRUQsS0FBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7Z0JBRXRCLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDbEIsQ0FBQyxDQUFDO2lCQUNELEtBQUssQ0FBQyxVQUFDLEtBQXVCO2dCQUMzQixLQUFLLENBQUM7b0JBQ0YsS0FBSyxFQUFFLDRCQUE0QjtvQkFDbkMsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO29CQUN0QixZQUFZLEVBQUUsSUFBSTtpQkFDckIsQ0FBQyxDQUFDO1lBQ1AsQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUM7SUFDL0IsQ0FBQztJQUVPLHdDQUFTLEdBQWpCLFVBQWtCLEtBQW9CO1FBQ2xDLElBQU0sV0FBVyxHQUFRO1lBQ3JCLFFBQVEsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRTtZQUNsQyxJQUFJLEVBQUU7Z0JBQ0YsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUNqQyxLQUFLLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDO2dCQUNuQyxHQUFHLEVBQUUsQ0FBQztnQkFDTixHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7YUFDL0I7WUFDRCxzQkFBc0IsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLHlCQUF5QixFQUFFO1lBQ2xFLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxvQkFBb0I7WUFDaEQsS0FBSyxtQkFBOEI7U0FDdEMsQ0FBQztRQUVGLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSx1QkFBb0MsQ0FBQyxDQUFDLENBQUM7WUFDMUQsSUFBTSxNQUFNLEdBQVE7Z0JBQ2hCLFlBQVksRUFBRSxJQUFJLElBQUksRUFBRTtnQkFDeEIsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztnQkFDckIsV0FBVyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFO2FBQ3RDLENBQUM7WUFFRixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxNQUFNLENBQUMsY0FBYyxHQUFHLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDO2dCQUNyQyxNQUFNLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztnQkFDMUIsTUFBTSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDN0IsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLE1BQU0sQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDO1lBQ2hDLENBQUM7WUFFRCxXQUFXLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNoQyxDQUFDO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQTVIUSxvQkFBb0I7UUFEaEMsaUJBQVUsRUFBRTs7T0FDQSxvQkFBb0IsQ0E2SGhDO0lBQUQsMkJBQUM7Q0FBQSxBQTdIRCxJQTZIQztBQTdIWSxvREFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEtpbnZleSB9IGZyb20gXCJraW52ZXktbmF0aXZlc2NyaXB0LXNka1wiO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSBcInJ4anNcIjtcblxuaW1wb3J0IHsgQ2FyZVBsYW5BY3Rpdml0eVR5cGUgfSBmcm9tIFwiLi9jYXJlLXBsYW4tYWN0aXZpdHktdHlwZS5lbnVtXCI7XG5pbXBvcnQgeyBDYXJlUGxhbkFjdGl2aXR5IH0gZnJvbSBcIi4vY2FyZS1wbGFuLWFjdGl2aXR5Lm1vZGVsXCI7XG5pbXBvcnQgeyBDYXJlUGxhbkV2ZW50IH0gZnJvbSBcIi4vY2FyZS1wbGFuLWV2ZW50Lm1vZGVsXCI7XG5cbmV4cG9ydCBjb25zdCBlbnVtIENhcmVQbGFuRXZlbnRTdGF0ZSB7XG4gICAgSW5pdGlhbCA9IDAsXG4gICAgTm90Q29tcGxldGVkID0gMSxcbiAgICBDb21wbGV0ZWQgPSAyXG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDYXJlQ2FyZEV2ZW50U2VydmljZSB7XG4gICAgdXBkYXRlZEV2ZW50JDogT2JzZXJ2YWJsZTxDYXJlUGxhbkV2ZW50PjtcblxuICAgIHByaXZhdGUgX3VwZGF0ZWRFdmVudEl0ZW1Tb3VyY2U6IEJlaGF2aW9yU3ViamVjdDxDYXJlUGxhbkV2ZW50PjtcbiAgICBwcml2YXRlIF9ldmVudHNEYXRhU3RvcmUgPSBLaW52ZXkuRGF0YVN0b3JlLmNvbGxlY3Rpb248YW55PihcIkV2ZW50XCIpO1xuICAgIHByaXZhdGUgX2V2ZW50czogQXJyYXk8Q2FyZVBsYW5FdmVudD47XG4gICAgcHJpdmF0ZSBfZXZlbnRzUHJvbWlzZTogUHJvbWlzZTxhbnk+O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuX2V2ZW50cyA9IG5ldyBBcnJheTxDYXJlUGxhbkV2ZW50PigpO1xuXG4gICAgICAgIC8vIE9ic2VydmFibGUgZXZlbnRzIHNvdXJjZVxuICAgICAgICB0aGlzLl91cGRhdGVkRXZlbnRJdGVtU291cmNlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDYXJlUGxhbkV2ZW50PihudWxsKTtcblxuICAgICAgICAvLyBPYnNlcnZhYmxlIGV2ZW50cyBzdHJlYW1cbiAgICAgICAgdGhpcy51cGRhdGVkRXZlbnQkID0gdGhpcy5fdXBkYXRlZEV2ZW50SXRlbVNvdXJjZS5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICB1cHNlcnRFdmVudChldmVudDogQ2FyZVBsYW5FdmVudCwgZXZlbnRzQ291bnQ6IG51bWJlcik6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbmRFdmVudHMoZXZlbnQuYWN0aXZpdHkudGl0bGUsIGV2ZW50LmRhdGUpXG4gICAgICAgICAgICAudGhlbigocmVnaXN0ZXJlZEV2ZW50czogQXJyYXk8Q2FyZVBsYW5FdmVudD4pID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcHJvbWlzZVF1ZXVlID0gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgICAgICAgICBpZiAocmVnaXN0ZXJlZEV2ZW50cy5sZW5ndGggPT09IGV2ZW50c0NvdW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBldmVudFRvVXBkYXRlID0gcmVnaXN0ZXJlZEV2ZW50cy5maW5kKChjdXJyZW50RXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnQub2NjdXJyZW5jZUluZGV4T2ZEYXkgPT09IGV2ZW50Lm9jY3VycmVuY2VJbmRleE9mRGF5O1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBldmVudFRvVXBkYXRlID0gZXZlbnQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICBwcm9taXNlUXVldWUgPSBwcm9taXNlUXVldWUudGhlbigoKSA9PiB0aGlzLnNhdmVFdmVudChldmVudCkpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlUXVldWU7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fdXBkYXRlZEV2ZW50SXRlbVNvdXJjZS5uZXh0KGV2ZW50KSk7XG4gICAgfVxuXG4gICAgZmluZEV2ZW50cyh0aXRsZTogc3RyaW5nLCBkYXRlOiBEYXRlKTogUHJvbWlzZTxBcnJheTxDYXJlUGxhbkV2ZW50Pj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRFdmVudHMoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkRXZlbnRzID0gdGhpcy5fZXZlbnRzLmZpbHRlcigoY3VycmVudEV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnQuZGF0ZS50b0RhdGVTdHJpbmcoKSA9PT0gZGF0ZS50b0RhdGVTdHJpbmcoKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEV2ZW50LmFjdGl2aXR5LnRpdGxlID09PSB0aXRsZTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJlZEV2ZW50cztcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RXZlbnRzKCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGlmICghdGhpcy5fZXZlbnRzUHJvbWlzZSkge1xuICAgICAgICAgICAgdGhpcy5fZXZlbnRzUHJvbWlzZSA9IHRoaXMuX2V2ZW50c0RhdGFTdG9yZS5maW5kKCkudG9Qcm9taXNlKClcbiAgICAgICAgICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBldmVudHMgPSBbXTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5mb3JFYWNoKChldmVudERhdGE6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2aXR5ID0gbmV3IENhcmVQbGFuQWN0aXZpdHkoZXZlbnREYXRhLmFjdGl2aXR5KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGpzb25EYXRlID0gZXZlbnREYXRhLmRhdGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKGpzb25EYXRlLnllYXIsIGpzb25EYXRlLm1vbnRoIC0gMSwganNvbkRhdGUuZGF5KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9jY3VycmVuY2VJbmRleE9mRGF5ID0gZXZlbnREYXRhLm9jY3VycmVuY2VJbmRleE9mRGF5O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZXZlbnREYXRhLnJlc3VsdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHJlc3VsdCAmJiByZXN1bHQudmFsdWVzICYmIHJlc3VsdC52YWx1ZXMubGVuZ3RoID8gcmVzdWx0LnZhbHVlc1swXSA6IDE7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBldmVudCA9IG5ldyBDYXJlUGxhbkV2ZW50KGFjdGl2aXR5LCBkYXRlLCBvY2N1cnJlbmNlSW5kZXhPZkRheSwgdmFsdWUpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzLnB1c2goZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHMgPSBldmVudHM7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50cztcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IEtpbnZleS5CYXNlRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYWxlcnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiT29wcyBzb21ldGhpbmcgd2VudCB3cm9uZy5cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBva0J1dHRvblRleHQ6IFwiT2tcIlxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9ldmVudHNQcm9taXNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2F2ZUV2ZW50KGV2ZW50OiBDYXJlUGxhbkV2ZW50KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgZXZlbnRPYmplY3Q6IGFueSA9IHtcbiAgICAgICAgICAgIGFjdGl2aXR5OiBldmVudC5hY3Rpdml0eS5nZXRKc29uKCksXG4gICAgICAgICAgICBkYXRlOiB7XG4gICAgICAgICAgICAgICAgeWVhcjogZXZlbnQuZGF0ZS5nZXRVVENGdWxsWWVhcigpLFxuICAgICAgICAgICAgICAgIG1vbnRoOiBldmVudC5kYXRlLmdldFVUQ01vbnRoKCkgKyAxLFxuICAgICAgICAgICAgICAgIGVyYTogMSxcbiAgICAgICAgICAgICAgICBkYXk6IGV2ZW50LmRhdGUuZ2V0VVRDRGF0ZSgpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbnVtYmVyT2ZEYXlzU2luY2VTdGFydDogZXZlbnQuYWN0aXZpdHkuZ2V0TnVtYmVyT2ZEYXlzU2luY2VTdGFydCgpLFxuICAgICAgICAgICAgb2NjdXJyZW5jZUluZGV4T2ZEYXk6IGV2ZW50Lm9jY3VycmVuY2VJbmRleE9mRGF5LFxuICAgICAgICAgICAgc3RhdGU6IENhcmVQbGFuRXZlbnRTdGF0ZS5Db21wbGV0ZWRcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoZXZlbnQuYWN0aXZpdHkudHlwZSA9PT0gQ2FyZVBsYW5BY3Rpdml0eVR5cGUuQXNzZXNzbWVudCkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0OiBhbnkgPSB7XG4gICAgICAgICAgICAgICAgY3JlYXRpb25EYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgICAgIHZhbHVlczogW2V2ZW50LnZhbHVlXSxcbiAgICAgICAgICAgICAgICB2YWx1ZVN0cmluZzogZXZlbnQudmFsdWUudG9TdHJpbmcoKVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKGV2ZW50LmFjdGl2aXR5LnRpdGxlID09PSBcIldlaWdodFwiKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnVuaXRTdHJpbmdLZXlzID0geyBsYjogXCJsYlwiIH07XG4gICAgICAgICAgICAgICAgcmVzdWx0LmRpc3BsYXlVbml0ID0gXCJsYlwiO1xuICAgICAgICAgICAgICAgIHJlc3VsdC51bml0U3RyaW5nID0gXCJsYlwiO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQudW5pdFN0cmluZyA9IFwib2YgMTBcIjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZXZlbnRPYmplY3QucmVzdWx0ID0gcmVzdWx0O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50c0RhdGFTdG9yZS5zYXZlKGV2ZW50T2JqZWN0KTtcbiAgICB9XG59XG4iXX0=